"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _index = require("./index");

var _index2 = _interopRequireDefault(_index);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var App = function () {
  _createClass(App, null, [{
    key: "PATH",

    /**
     * Provides access to the `applications` version 2 endpoint.
     */
    get: function get() {
      return "/v2/applications";
    }
    /**
     * @param {Credentials} credentials
     *    credentials to be used when interacting with the API.
     * @param {Object} options
     *    Addition App options.
     */

  }]);

  function App(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    _classCallCheck(this, App);

    this.creds = credentials;
    this.options = options;

    // Used to facilitate testing of the call to the underlying object
    this._nexmo = this.options.nexmoOverride || _index2.default;
  }

  _createClass(App, [{
    key: "_convertMethodSignature",
    value: function _convertMethodSignature(name, type, answerUrl, eventUrl, options) {
      var capability = {};
      switch (type) {
        case "voice":
          capability = {
            voice: {
              webhooks: {
                answer_url: {
                  address: answerUrl,
                  http_method: "GET"
                },
                event_url: {
                  address: eventUrl,
                  http_method: "POST"
                }
              }
            }
          };
          break;
        case "messages":
          capability = {
            messages: {
              webhooks: {
                inbound_url: {
                  address: options.inbound_url,
                  http_method: "POST"
                },
                status_url: {
                  address: options.status_url,
                  http_method: "POST"
                }
              }
            }
          };
          break;
        case "rtc":
          capability = {
            rtc: {
              webhooks: {
                event_url: {
                  address: eventUrl,
                  http_method: "POST"
                }
              }
            }
          };
          break;
      }

      return {
        name: name,
        capabilities: capability
      };
    }
  }, {
    key: "_convertApplicationResponse",
    value: function _convertApplicationResponse(application) {
      for (var capability in application.capabilities) {
        application[capability] = {
          webhooks: []
        };
        for (var webhook in application.capabilities[capability].webhooks) {
          application[capability].webhooks.push({
            endpoint_type: webhook,
            endpoint: application.capabilities[capability].webhooks[webhook].address,
            http_method: application.capabilities[capability].webhooks[webhook].http_method
          });
        }
      }

      delete application.capabilities;
      return application;
    }
  }, {
    key: "_convertApplicationListResponse",
    value: function _convertApplicationListResponse(applicationResponseHandler) {
      return function (response) {
        for (var i in response._embedded.applications) {
          response._embedded.applications[i] = applicationResponseHandler(response._embedded.applications[i]);
        }

        return response;
      };
    }

    /**
     * TODO: document
     */

  }, {
    key: "create",
    value: function create(name, type, answerUrl, eventUrl, options, callback) {
      var params = {};
      var responseParser = null;

      if (arguments.length > 2) {
        params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
        responseParser = this._convertApplicationResponse;
      } else {
        params = JSON.stringify(name);
        callback = type;
      }

      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;

      var config = {
        host: "api.nexmo.com",
        path: App.PATH,
        method: "POST",
        body: params,
        headers: {
          "Content-Type": "application/json",
          Authorization: "Basic " + Buffer.from(authorization).toString("base64")
        }
      };

      this.options.httpClient.request(config, callback, callback, false, responseParser);
    }

    /**
     * TODO: document
     */

  }, {
    key: "get",
    value: function get(params, callback) {
      var v2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;

      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;
      var responseParser = null;

      if ((typeof params === "undefined" ? "undefined" : _typeof(params)) !== "object") {
        var config = {
          host: "api.nexmo.com",
          path: App.PATH + "/" + params,
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Basic " + Buffer.from(authorization).toString("base64")
          }
        };
        responseParser = this._convertApplicationResponse;
      } else {
        var config = {
          host: "api.nexmo.com",
          path: App.PATH,
          method: "GET",
          body: JSON.stringify(params),
          headers: {
            "Content-Type": "application/json",
            Authorization: "Basic " + Buffer.from(authorization).toString("base64")
          }
        };
        responseParser = this._convertApplicationListResponse(this._convertApplicationResponse);
      }

      if (v2) {
        responseParser = null;
      }

      this.options.httpClient.request(config, callback, callback, false, responseParser);
    }

    /**
     * TODO: document
     */

  }, {
    key: "update",
    value: function update(appId, name, type, answerUrl, eventUrl, options, callback) {
      var params = {};
      var responseParser = null;
      if (arguments.length > 3) {
        params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
        responseParser = this._convertApplicationResponse;
      } else {
        params = JSON.stringify(name);
        callback = type;
      }

      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;

      var config = {
        host: "api.nexmo.com",
        path: App.PATH + "/" + appId,
        method: "PUT",
        body: params,
        headers: {
          "Content-Type": "application/json",
          Authorization: "Basic " + Buffer.from(authorization).toString("base64")
        }
      };

      this.options.httpClient.request(config, callback, callback, false, responseParser);
    }

    /**
     * TODO: document
     */

  }, {
    key: "delete",
    value: function _delete(appId, callback) {
      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;

      var config = {
        host: "api.nexmo.com",
        path: App.PATH + "/" + appId,
        method: "DELETE",
        body: "{}",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Basic " + Buffer.from(authorization).toString("base64")
        }
      };

      this.options.httpClient.request(config, callback);
    }
  }]);

  return App;
}();

exports.default = App;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHAuanMiXSwibmFtZXMiOlsiQXBwIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfbmV4bW8iLCJuZXhtb092ZXJyaWRlIiwibmV4bW8iLCJuYW1lIiwidHlwZSIsImFuc3dlclVybCIsImV2ZW50VXJsIiwiY2FwYWJpbGl0eSIsInZvaWNlIiwid2ViaG9va3MiLCJhbnN3ZXJfdXJsIiwiYWRkcmVzcyIsImh0dHBfbWV0aG9kIiwiZXZlbnRfdXJsIiwibWVzc2FnZXMiLCJpbmJvdW5kX3VybCIsInN0YXR1c191cmwiLCJydGMiLCJjYXBhYmlsaXRpZXMiLCJhcHBsaWNhdGlvbiIsIndlYmhvb2siLCJwdXNoIiwiZW5kcG9pbnRfdHlwZSIsImVuZHBvaW50IiwiYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIiLCJpIiwicmVzcG9uc2UiLCJfZW1iZWRkZWQiLCJhcHBsaWNhdGlvbnMiLCJjYWxsYmFjayIsInBhcmFtcyIsInJlc3BvbnNlUGFyc2VyIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiSlNPTiIsInN0cmluZ2lmeSIsIl9jb252ZXJ0TWV0aG9kU2lnbmF0dXJlIiwiX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlIiwiYXV0aG9yaXphdGlvbiIsImFwaUtleSIsImFwaVNlY3JldCIsImNvbmZpZyIsImhvc3QiLCJwYXRoIiwiUEFUSCIsIm1ldGhvZCIsImJvZHkiLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwidjIiLCJfY29udmVydEFwcGxpY2F0aW9uTGlzdFJlc3BvbnNlIiwiYXBwSWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7O0FBRUE7Ozs7Ozs7O0lBRU1BLEc7Ozs7QUFDSjs7O3dCQUdrQjtBQUNoQixhQUFPLGtCQUFQO0FBQ0Q7QUFDRDs7Ozs7Ozs7O0FBTUEsZUFBWUMsV0FBWixFQUF1QztBQUFBLFFBQWRDLE9B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O0FBRUEsVUFBSUMsU0FBUztBQUNYQyxjQUFNLGVBREs7QUFFWEMsY0FBUy9DLElBQUlnRCxJQUFiLFNBQXFCWSxLQUZWO0FBR1hYLGdCQUFRLEtBSEc7QUFJWEMsY0FBTWhCLE1BSks7QUFLWGlCLGlCQUFTO0FBQ1AsMEJBQWdCLGtCQURUO0FBRVBDLG9DQUF3QkMsT0FBT0MsSUFBUCxDQUFZWixhQUFaLEVBQTJCYSxRQUEzQixDQUFvQyxRQUFwQztBQUZqQjtBQUxFLE9BQWI7O0FBV0EsV0FBS3JELE9BQUwsQ0FBYXNELFVBQWIsQ0FBd0JDLE9BQXhCLENBQ0VaLE1BREYsRUFFRVosUUFGRixFQUdFQSxRQUhGLEVBSUUsS0FKRixFQUtFRSxjQUxGO0FBT0Q7O0FBRUQ7Ozs7Ozs0QkFHT3lCLEssRUFBTzNCLFEsRUFBVTtBQUN0QixVQUFNUyxnQkFBbUIsS0FBS3ZDLEtBQUwsQ0FBV3dDLE1BQTlCLFNBQXdDLEtBQUt4QyxLQUFMLENBQVd5QyxTQUF6RDs7QUFFQSxVQUFJQyxTQUFTO0FBQ1hDLGNBQU0sZUFESztBQUVYQyxjQUFTL0MsSUFBSWdELElBQWIsU0FBcUJZLEtBRlY7QUFHWFgsZ0JBQVEsUUFIRztBQUlYQyxjQUFNLElBSks7QUFLWEMsaUJBQVM7QUFDUCwwQkFBZ0Isa0JBRFQ7QUFFUEMsb0NBQXdCQyxPQUFPQyxJQUFQLENBQVlaLGFBQVosRUFBMkJhLFFBQTNCLENBQW9DLFFBQXBDO0FBRmpCO0FBTEUsT0FBYjs7QUFXQSxXQUFLckQsT0FBTCxDQUFhc0QsVUFBYixDQUF3QkMsT0FBeEIsQ0FBZ0NaLE1BQWhDLEVBQXdDWixRQUF4QztBQUNEOzs7Ozs7a0JBR1lqQyxHIiwiZmlsZSI6IkFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgbmV4bW8gZnJvbSBcIi4vaW5kZXhcIjtcblxuY2xhc3MgQXBwIHtcbiAgLyoqXG4gICAqIFByb3ZpZGVzIGFjY2VzcyB0byB0aGUgYGFwcGxpY2F0aW9uc2AgdmVyc2lvbiAyIGVuZHBvaW50LlxuICAgKi9cbiAgc3RhdGljIGdldCBQQVRIKCkge1xuICAgIHJldHVybiBcIi92Mi9hcHBsaWNhdGlvbnNcIjtcbiAgfVxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gQXBwIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICAvLyBVc2VkIHRvIGZhY2lsaXRhdGUgdGVzdGluZyBvZiB0aGUgY2FsbCB0byB0aGUgdW5kZXJseWluZyBvYmplY3RcbiAgICB0aGlzLl9uZXhtbyA9IHRoaXMub3B0aW9ucy5uZXhtb092ZXJyaWRlIHx8IG5leG1vO1xuICB9XG5cbiAgX2NvbnZlcnRNZXRob2RTaWduYXR1cmUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucykge1xuICAgIGxldCBjYXBhYmlsaXR5ID0ge307XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIFwidm9pY2VcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICB2b2ljZToge1xuICAgICAgICAgICAgd2ViaG9va3M6IHtcbiAgICAgICAgICAgICAgYW5zd2VyX3VybDoge1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFuc3dlclVybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJHRVRcIlxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBldmVudF91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBldmVudFVybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJQT1NUXCJcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwibWVzc2FnZXNcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICBtZXNzYWdlczoge1xuICAgICAgICAgICAgd2ViaG9va3M6IHtcbiAgICAgICAgICAgICAgaW5ib3VuZF91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBvcHRpb25zLmluYm91bmRfdXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBzdGF0dXNfdXJsOiB7XG4gICAgICAgICAgICAgICAgYWRkcmVzczogb3B0aW9ucy5zdGF0dXNfdXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJydGNcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICBydGM6IHtcbiAgICAgICAgICAgIHdlYmhvb2tzOiB7XG4gICAgICAgICAgICAgIGV2ZW50X3VybDoge1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGV2ZW50VXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogbmFtZSxcbiAgICAgIGNhcGFiaWxpdGllczogY2FwYWJpbGl0eVxuICAgIH07XG4gIH1cblxuICBfY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2UoYXBwbGljYXRpb24pIHtcbiAgICBmb3IgKGxldCBjYXBhYmlsaXR5IGluIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllcykge1xuICAgICAgYXBwbGljYXRpb25bY2FwYWJpbGl0eV0gPSB7XG4gICAgICAgIHdlYmhvb2tzOiBbXVxuICAgICAgfTtcbiAgICAgIGZvciAobGV0IHdlYmhvb2sgaW4gYXBwbGljYXRpb24uY2FwYWJpbGl0aWVzW2NhcGFiaWxpdHldLndlYmhvb2tzKSB7XG4gICAgICAgIGFwcGxpY2F0aW9uW2NhcGFiaWxpdHldLndlYmhvb2tzLnB1c2goe1xuICAgICAgICAgIGVuZHBvaW50X3R5cGU6IHdlYmhvb2ssXG4gICAgICAgICAgZW5kcG9pbnQ6XG4gICAgICAgICAgICBhcHBsaWNhdGlvbi5jYXBhYmlsaXRpZXNbY2FwYWJpbGl0eV0ud2ViaG9va3Nbd2ViaG9va10uYWRkcmVzcyxcbiAgICAgICAgICBodHRwX21ldGhvZDpcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllc1tjYXBhYmlsaXR5XS53ZWJob29rc1t3ZWJob29rXS5odHRwX21ldGhvZFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkZWxldGUgYXBwbGljYXRpb24uY2FwYWJpbGl0aWVzO1xuICAgIHJldHVybiBhcHBsaWNhdGlvbjtcbiAgfVxuXG4gIF9jb252ZXJ0QXBwbGljYXRpb25MaXN0UmVzcG9uc2UoYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIpIHtcbiAgICByZXR1cm4gcmVzcG9uc2UgPT4ge1xuICAgICAgZm9yIChsZXQgaSBpbiByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zKSB7XG4gICAgICAgIHJlc3BvbnNlLl9lbWJlZGRlZC5hcHBsaWNhdGlvbnNbaV0gPSBhcHBsaWNhdGlvblJlc3BvbnNlSGFuZGxlcihcbiAgICAgICAgICByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zW2ldXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBjcmVhdGUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBsZXQgcGFyYW1zID0ge307XG4gICAgbGV0IHJlc3BvbnNlUGFyc2VyID0gbnVsbDtcblxuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikge1xuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHRoaXMuX2NvbnZlcnRNZXRob2RTaWduYXR1cmUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucylcbiAgICAgICk7XG4gICAgICByZXNwb25zZVBhcnNlciA9IHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShuYW1lKTtcbiAgICAgIGNhbGxiYWNrID0gdHlwZTtcbiAgICB9XG5cbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcblxuICAgIHZhciBjb25maWcgPSB7XG4gICAgICBob3N0OiBcImFwaS5uZXhtby5jb21cIixcbiAgICAgIHBhdGg6IEFwcC5QQVRILFxuICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgIGJvZHk6IHBhcmFtcyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIGNvbmZpZyxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBmYWxzZSxcbiAgICAgIHJlc3BvbnNlUGFyc2VyXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgZ2V0KHBhcmFtcywgY2FsbGJhY2ssIHYyID0gZmFsc2UpIHtcbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcbiAgICBsZXQgcmVzcG9uc2VQYXJzZXIgPSBudWxsO1xuXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgIHZhciBjb25maWcgPSB7XG4gICAgICAgIGhvc3Q6IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgICBwYXRoOiBgJHtBcHAuUEFUSH0vJHtwYXJhbXN9YCxcbiAgICAgICAgbWV0aG9kOiBcIkdFVFwiLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJhc2ljICR7QnVmZmVyLmZyb20oYXV0aG9yaXphdGlvbikudG9TdHJpbmcoXG4gICAgICAgICAgICBcImJhc2U2NFwiXG4gICAgICAgICAgKX1gXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICByZXNwb25zZVBhcnNlciA9IHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICBob3N0OiBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgcGF0aDogQXBwLlBBVEgsXG4gICAgICAgIG1ldGhvZDogXCJHRVRcIixcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGFyYW1zKSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFxuICAgICAgICAgICAgXCJiYXNlNjRcIlxuICAgICAgICAgICl9YFxuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgcmVzcG9uc2VQYXJzZXIgPSB0aGlzLl9jb252ZXJ0QXBwbGljYXRpb25MaXN0UmVzcG9uc2UoXG4gICAgICAgIHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICh2Mikge1xuICAgICAgcmVzcG9uc2VQYXJzZXIgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICBjb25maWcsXG4gICAgICBjYWxsYmFjayxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgZmFsc2UsXG4gICAgICByZXNwb25zZVBhcnNlclxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHVwZGF0ZShhcHBJZCwgbmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBsZXQgcGFyYW1zID0ge307XG4gICAgbGV0IHJlc3BvbnNlUGFyc2VyID0gbnVsbDtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDMpIHtcbiAgICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB0aGlzLl9jb252ZXJ0TWV0aG9kU2lnbmF0dXJlKG5hbWUsIHR5cGUsIGFuc3dlclVybCwgZXZlbnRVcmwsIG9wdGlvbnMpXG4gICAgICApO1xuICAgICAgcmVzcG9uc2VQYXJzZXIgPSB0aGlzLl9jb252ZXJ0QXBwbGljYXRpb25SZXNwb25zZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkobmFtZSk7XG4gICAgICBjYWxsYmFjayA9IHR5cGU7XG4gICAgfVxuXG4gICAgY29uc3QgYXV0aG9yaXphdGlvbiA9IGAke3RoaXMuY3JlZHMuYXBpS2V5fToke3RoaXMuY3JlZHMuYXBpU2VjcmV0fWA7XG5cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgaG9zdDogXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICBwYXRoOiBgJHtBcHAuUEFUSH0vJHthcHBJZH1gLFxuICAgICAgbWV0aG9kOiBcIlBVVFwiLFxuICAgICAgYm9keTogcGFyYW1zLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJhc2ljICR7QnVmZmVyLmZyb20oYXV0aG9yaXphdGlvbikudG9TdHJpbmcoXCJiYXNlNjRcIil9YFxuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgY29uZmlnLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBjYWxsYmFjayxcbiAgICAgIGZhbHNlLFxuICAgICAgcmVzcG9uc2VQYXJzZXJcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBkZWxldGUoYXBwSWQsIGNhbGxiYWNrKSB7XG4gICAgY29uc3QgYXV0aG9yaXphdGlvbiA9IGAke3RoaXMuY3JlZHMuYXBpS2V5fToke3RoaXMuY3JlZHMuYXBpU2VjcmV0fWA7XG5cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgaG9zdDogXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICBwYXRoOiBgJHtBcHAuUEFUSH0vJHthcHBJZH1gLFxuICAgICAgbWV0aG9kOiBcIkRFTEVURVwiLFxuICAgICAgYm9keTogXCJ7fVwiLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJhc2ljICR7QnVmZmVyLmZyb20oYXV0aG9yaXphdGlvbikudG9TdHJpbmcoXCJiYXNlNjRcIil9YFxuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KGNvbmZpZywgY2FsbGJhY2spO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFwcDtcbiJdfQ==