"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _index = require("./index");

var _index2 = _interopRequireDefault(_index);

var _fs = require("fs");

var _fs2 = _interopRequireDefault(_fs);

var _querystring = require("querystring");

var _querystring2 = _interopRequireDefault(_querystring);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Media = function () {
  _createClass(Media, null, [{
    key: "PATH",
    get: function get() {
      return "/v3/media";
    }
  }]);

  function Media(credentials, options) {
    _classCallCheck(this, Media);

    this.creds = credentials;
    this.options = options;

    // Used to facilitate testing of the call to the underlying object
    this._nexmo = this.options.nexmoOverride || _index2.default;

    this._nexmo.initialize(this.creds.apiKey, this.creds.apiSecret, this.options);
  }

  _createClass(Media, [{
    key: "upload",
    value: function upload(opts, callback) {
      opts = opts || {};
      if (!opts.file && !opts.url) {
        throw new Error("You must provide either 'file' or 'url' to upload a file");
      }

      if (opts.file) {
        opts.file = _fs2.default.createReadStream(opts.file);
      }
      return this.options.api.postFile(Media.PATH, opts, function (err, response, body) {
        if (err) {
          return callback(err);
        }

        var location = "";
        if (response && response.headers) {
          location = response.headers.location;
        }

        return callback(null, location);
      }, true);
    }
  }, {
    key: "search",
    value: function search(options, callback) {
      if (typeof options == "function" && !callback) {
        callback = options;
        options = {};
      }

      options = options || {};

      return this._makeRequest("GET", Media.PATH, options, {}, callback);
    }

    // If If-Modified-Since header is provided and the data hasn't changed, the
    // user will receive an empty body in the callback, NOT an error

  }, {
    key: "download",
    value: function download(id, headers, callback) {
      if (!callback && typeof headers == "function") {
        callback = headers;
        headers = {};
      }

      return this._makeRequest("GET", Media.PATH + "/" + id, {}, headers, callback, true);
    }
  }, {
    key: "delete",
    value: function _delete(id, callback) {
      return this._makeRequest("DELETE", Media.PATH + "/" + id, {}, {}, callback);
    }
  }, {
    key: "get",
    value: function get(id, callback) {
      return this._makeRequest("GET", Media.PATH + "/" + id + "/info", {}, {}, callback);
    }
  }, {
    key: "update",
    value: function update(id, opts, callback) {
      return this._makeRequest("PUT", Media.PATH + "/" + id + "/info", opts, {}, callback);
    }
  }, {
    key: "_makeRequest",
    value: function _makeRequest(verb, path, options, headers, callback, skipJsonParsing) {
      headers = Object.assign({
        "Content-Type": "application/json",
        Authorization: "Bearer " + this.creds.generateJwt()
      }, headers);

      var req = {};
      if (verb.toUpperCase() === "GET") {
        if (Object.keys(options).length) {
          path = path + "?" + _querystring2.default.stringify(options);
        }
      } else {
        req["body"] = JSON.stringify(options);
      }

      req["path"] = path;
      req["headers"] = headers;

      return this.options.api.request(req, verb, callback, skipJsonParsing);
    }
  }]);

  return Media;
}();

exports.default = Media;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZWRpYS5qcyJdLCJuYW1lcyI6WyJNZWRpYSIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX25leG1vIiwibmV4bW9PdmVycmlkZSIsIm5leG1vIiwiaW5pdGlhbGl6ZSIsImFwaUtleSIsImFwaVNlY3JldCIsIm9wdHMiLCJjYWxsYmFjayIsImZpbGUiLCJ1cmwiLCJFcnJvciIsImZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsImFwaSIsInBvc3RGaWxlIiwiUEFUSCIsImVyciIsInJlc3BvbnNlIiwiYm9keSIsImxvY2F0aW9uIiwiaGVhZGVycyIsIl9tYWtlUmVxdWVzdCIsImlkIiwidmVyYiIsInBhdGgiLCJza2lwSnNvblBhcnNpbmciLCJPYmplY3QiLCJhc3NpZ24iLCJBdXRob3JpemF0aW9uIiwiZ2VuZXJhdGVKd3QiLCJyZXEiLCJ0b1VwcGVyQ2FzZSIsImtleXMiLCJsZW5ndGgiLCJxdWVyeXN0cmluZyIsInN0cmluZ2lmeSIsIkpTT04iLCJyZXF1ZXN0Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7Ozs7O0lBRU1BLEs7Ozt3QkFDYztBQUNoQixhQUFPLFdBQVA7QUFDRDs7O0FBRUQsaUJBQVlDLFdBQVosRUFBeUJDLE9BQXpCLEVBQWtDO0FBQUE7O0FBQ2hDLFNBQUtDLEtBQUwsR0FBYUYsV0FBYjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjs7QUFFQTtBQUNBLFNBQUtFLE1BQUwsR0FBYyxLQUFLRixPQUFMLENBQWFHLGFBQWIsSUFBOEJDLGVBQTVDOztBQUVBLFNBQUtGLE1BQUwsQ0FBWUcsVUFBWixDQUNFLEtBQUtKLEtBQUwsQ0FBV0ssTUFEYixFQUVFLEtBQUtMLEtBQUwsQ0FBV00sU0FGYixFQUdFLEtBQUtQLE9BSFA7QUFLRDs7OzsyQkFFTVEsSSxFQUFNQyxRLEVBQVU7QUFDckJELGFBQU9BLFFBQVEsRUFBZjtBQUNBLFVBQUksQ0FBQ0EsS0FBS0UsSUFBTixJ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LFlBQUksTUFBSixJQUFjTSxLQUFLRCxTQUFMLENBQWVyQyxPQUFmLENBQWQ7QUFDRDs7QUFFRGdDLFVBQUksTUFBSixJQUFjTixJQUFkO0FBQ0FNLFVBQUksU0FBSixJQUFpQlYsT0FBakI7O0FBRUEsYUFBTyxLQUFLdEIsT0FBTCxDQUFhZSxHQUFiLENBQWlCd0IsT0FBakIsQ0FBeUJQLEdBQXpCLEVBQThCUCxJQUE5QixFQUFvQ2hCLFFBQXBDLEVBQThDa0IsZUFBOUMsQ0FBUDtBQUNEOzs7Ozs7a0JBR1k3QixLIiwiZmlsZSI6Ik1lZGlhLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBuZXhtbyBmcm9tIFwiLi9pbmRleFwiO1xuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IHF1ZXJ5c3RyaW5nIGZyb20gXCJxdWVyeXN0cmluZ1wiO1xuXG5jbGFzcyBNZWRpYSB7XG4gIHN0YXRpYyBnZXQgUEFUSCgpIHtcbiAgICByZXR1cm4gXCIvdjMvbWVkaWFcIjtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKGNyZWRlbnRpYWxzLCBvcHRpb25zKSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICAvLyBVc2VkIHRvIGZhY2lsaXRhdGUgdGVzdGluZyBvZiB0aGUgY2FsbCB0byB0aGUgdW5kZXJseWluZyBvYmplY3RcbiAgICB0aGlzLl9uZXhtbyA9IHRoaXMub3B0aW9ucy5uZXhtb092ZXJyaWRlIHx8IG5leG1vO1xuXG4gICAgdGhpcy5fbmV4bW8uaW5pdGlhbGl6ZShcbiAgICAgIHRoaXMuY3JlZHMuYXBpS2V5LFxuICAgICAgdGhpcy5jcmVkcy5hcGlTZWNyZXQsXG4gICAgICB0aGlzLm9wdGlvbnNcbiAgICApO1xuICB9XG5cbiAgdXBsb2FkKG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgb3B0cyA9IG9wdHMgfHwge307XG4gICAgaWYgKCFvcHRzLmZpbGUgJiYgIW9wdHMudXJsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiWW91IG11c3QgcHJvdmlkZSBlaXRoZXIgJ2ZpbGUnIG9yICd1cmwnIHRvIHVwbG9hZCBhIGZpbGVcIlxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAob3B0cy5maWxlKSB7XG4gICAgICBvcHRzLmZpbGUgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKG9wdHMuZmlsZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLm9wdGlvbnMuYXBpLnBvc3RGaWxlKFxuICAgICAgTWVkaWEuUEFUSCxcbiAgICAgIG9wdHMsXG4gICAgICBmdW5jdGlvbihlcnIsIHJlc3BvbnNlLCBib2R5KSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsb2NhdGlvbiA9IFwiXCI7XG4gICAgICAgIGlmIChyZXNwb25zZSAmJiByZXNwb25zZS5oZWFkZXJzKSB7XG4gICAgICAgICAgbG9jYXRpb24gPSByZXNwb25zZS5oZWFkZXJzLmxvY2F0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGxvY2F0aW9uKTtcbiAgICAgIH0sXG4gICAgICB0cnVlXG4gICAgKTtcbiAgfVxuXG4gIHNlYXJjaChvcHRpb25zLCBjYWxsYmFjaykge1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PSBcImZ1bmN0aW9uXCIgJiYgIWNhbGxiYWNrKSB7XG4gICAgICBjYWxsYmFjayA9IG9wdGlvbnM7XG4gICAgICBvcHRpb25zID0ge307XG4gICAgfVxuXG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG5cbiAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3QoXCJHRVRcIiwgTWVkaWEuUEFUSCwgb3B0aW9ucywge30sIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8vIElmIElmLU1vZGlmaWVkLVNpbmNlIGhlYWRlciBpcyBwcm92aWRlZCBhbmQgdGhlIGRhdGEgaGFzbid0IGNoYW5nZWQsIHRoZVxuICAvLyB1c2VyIHdpbGwgcmVjZWl2ZSBhbiBlbXB0eSBib2R5IGluIHRoZSBjYWxsYmFjaywgTk9UIGFuIGVycm9yXG4gIGRvd25sb2FkKGlkLCBoZWFkZXJzLCBjYWxsYmFjaykge1xuICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIGhlYWRlcnMgPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjYWxsYmFjayA9IGhlYWRlcnM7XG4gICAgICBoZWFkZXJzID0ge307XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KFxuICAgICAgXCJHRVRcIixcbiAgICAgIGAke01lZGlhLlBBVEh9LyR7aWR9YCxcbiAgICAgIHt9LFxuICAgICAgaGVhZGVycyxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgdHJ1ZVxuICAgICk7XG4gIH1cblxuICBkZWxldGUoaWQsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KFwiREVMRVRFXCIsIGAke01lZGlhLlBBVEh9LyR7aWR9YCwge30sIHt9LCBjYWxsYmFjayk7XG4gIH1cblxuICBnZXQoaWQsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KFxuICAgICAgXCJHRVRcIixcbiAgICAgIGAke01lZGlhLlBBVEh9LyR7aWR9L2luZm9gLFxuICAgICAge30sXG4gICAgICB7fSxcbiAgICAgIGNhbGxiYWNrXG4gICAgKTtcbiAgfVxuXG4gIHVwZGF0ZShpZCwgb3B0cywgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3QoXG4gICAgICBcIlBVVFwiLFxuICAgICAgYCR7TWVkaWEuUEFUSH0vJHtpZH0vaW5mb2AsXG4gICAgICBvcHRzLFxuICAgICAge30sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBfbWFrZVJlcXVlc3QodmVyYiwgcGF0aCwgb3B0aW9ucywgaGVhZGVycywgY2FsbGJhY2ssIHNraXBKc29uUGFyc2luZykge1xuICAgIGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKFxuICAgICAge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuY3JlZHMuZ2VuZXJhdGVKd3QoKX1gXG4gICAgICB9LFxuICAgICAgaGVhZGVyc1xuICAgICk7XG5cbiAgICBsZXQgcmVxID0ge307XG4gICAgaWYgKHZlcmIudG9VcHBlckNhc2UoKSA9PT0gXCJHRVRcIikge1xuICAgICAgaWYgKE9iamVjdC5rZXlzKG9wdGlvbnMpLmxlbmd0aCkge1xuICAgICAgICBwYXRoID0gcGF0aCArIFwiP1wiICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KG9wdGlvbnMpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXFbXCJib2R5XCJdID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcmVxW1wicGF0aFwiXSA9IHBhdGg7XG4gICAgcmVxW1wiaGVhZGVyc1wiXSA9IGhlYWRlcnM7XG5cbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLmFwaS5yZXF1ZXN0KHJlcSwgdmVyYiwgY2FsbGJhY2ssIHNraXBKc29uUGFyc2luZyk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWVkaWE7XG4iXX0=